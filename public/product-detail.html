<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Brundavanam Goshala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/logo.png">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .thumbnail-active {
            border-color: #4c51bf; /* A distinct color like indigo */
        }
        /* Cart count animation */
        .cart-count-animate {
            animation: pop 0.3s ease-in-out;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        /* Spinner animation */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.75s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom Logo Loader */
        .loader-logo {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        /* Header shrink styles */
        #header-inner {
            transition: height 0.3s ease-in-out;
        }
        #logo-link {
            transition: font-size 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-stone-50">

    <div id="page-loader" class="fixed inset-0 z-[9999] flex items-center justify-center bg-white transition-opacity duration-300 ease-in-out">
        <img src="/logo.png" alt="Brundavanam Goshala Logo" class="loader-logo w-24 h-24">
    </div>
    
    <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div id="header-inner" class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a id="logo-link" href="index.html" class="text-xl sm:text-2xl font-bold text-green-800 hover:text-green-700">Brundavanam Goshala</a>
                </div>
                <nav class="hidden md:flex items-center space-x-8 text-base">
                    <a href="index.html" class="text-stone-600 hover:text-green-700 py-2 font-medium">HOME</a>
                    <a href="about.html" class="text-stone-600 hover:text-green-700 py-2 font-medium">ABOUT US</a>
                    <a href="contact.html" class="text-stone-600 hover:text-green-700 py-2 font-medium">SUPPORT</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <a href="cart.html" class="relative text-stone-600 hover:text-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg>
                        <span id="cart-count" class="absolute -top-2 -right-2 bg-amber-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </a>
                    <button id="mobile-menu-button" class="md-hidden text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white/80 backdrop-blur-sm border-t p-4 space-y-2">
            <a href="index.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Home</a>
            <a href="about.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">About Us</a>
            <a href="contact.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Support</a>
        </div>
    </header>

    <main id="main-content" class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        </main>
    
    <footer class="bg-stone-800 text-white mt-12">
        <div class="container mx-auto px-8 py-12 text-center">
            <p class="font-bold text-2xl mb-2">Brundavanam Goshala</p>
            <div class="flex justify-center space-x-6">
                 <a href="about.html" class="text-stone-300 hover:text-white">About Us</a>
                 <a href="contact.html" class="text-stone-300 hover:text-white">Contact & Support</a>
                 <a href="#" class="text-stone-300 hover:text-white">Terms of Service</a>
            </div>
        </div>
    </footer>

    <div id="cart-notification" class="fixed bottom-5 right-5 bg-green-700 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 ease-in-out z-50 max-w-md">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3 shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                <span id="notification-message">Item added to cart!</span>
            </div>
            <a href="cart.html" class="ml-6 shrink-0 text-sm font-semibold bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md">View Cart</a>
        </div>
    </div>

    <script type="module">
        import { loadProducts } from '/data.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const mainContent = document.getElementById('main-content');
            const cartCountElement = document.getElementById('cart-count');
            let products = [];
            
            // --- **FIX 1:** CORRECTED FUNCTION TO SAVE ONLY CART STATE ---
            function saveProductsToStorage() {
                const cartState = products
                    .filter(p => p.inCart)
                    .map(({id, inCart, quantity}) => ({id, inCart, quantity}));
                localStorage.setItem('goshalaProducts', JSON.stringify(cartState));
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const productId = parseInt(urlParams.get('id'));
            let product;
            let allComments = [];
            let currentSort = 'newest';
            let activeStarFilters = [];

            try {
                products = await loadProducts();
                product = products.find(p => p.id === productId);

                if (product) {
                    // Fetch comments separately now that we have the MongoDB _id
                    const commentsResponse = await fetch(`/api/comments/${product._id}`);
                    if (!commentsResponse.ok) {
                        throw new Error('Failed to fetch comments.');
                    }
                    const commentsData = await commentsResponse.json();
                    // Ensure allComments is always an array, whether the API sends an array or a paginated object.
                    allComments = Array.isArray(commentsData) ? commentsData : (commentsData.comments || []);
                    const comments = allComments; // comments is now guaranteed to be an array
                    renderProductDetails(product, comments);
                } else {
                    mainContent.innerHTML = `<div class="text-center py-20"><h1 class="text-2xl font-bold text-stone-700">Product not found.</h1><a href="index.html" class="text-green-700 hover:underline mt-4 inline-block">Go back to Home</a></div>`;
                }
            } catch (error) {
                mainContent.innerHTML = `<div class="text-center py-20"><h1 class="text-2xl font-bold text-red-600">Error loading product.</h1><p>${error.message}</p></div>`;
            }

            function getNewStatus(dateString) {
                if (!dateString) return null;
                const now = new Date();
                const productDate = new Date(dateString);
                if (productDate > now) return null;
                const diffTime = now - productDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 15) return 'new';
                if (diffDays <= 30) return 'recent';
                return null;
            }

            function renderProductDetails(p, comments) {
                document.title = `${p.name} - Brundavanam Goshala`;
                const discount = p.originalPrice ? Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100) : 0;
                
                const images = Array.isArray(p.images) ? p.images : [];
                const mainImageSrc = images.length > 0 ? images[0] : 'https://placehold.co/600x600/CCCCCC/FFFFFF?text=No+Image';

                mainContent.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                        <div>
                            <img id="main-product-image" src="${mainImageSrc}" alt="${p.name}" class="w-full rounded-lg shadow-md mb-4">
                            <div id="thumbnail-gallery" class="flex space-x-2">
                                ${images.map((img, index) => `<img src="${img}" alt="Thumbnail ${index+1}" class="w-20 h-20 object-cover rounded-md cursor-pointer border-2 ${index === 0 ? 'border-green-700' : 'border-transparent'}" data-index="${index}">`).join('')}
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <div class="flex items-center flex-wrap gap-x-4 gap-y-2 mb-2">
                                <h1 class="text-3xl md:text-4xl font-bold text-stone-800">${p.name}</h1>
                                ${(() => {
                                    const badges = [];
                                    const newStatus = getNewStatus(p.dateAdded);
                                    if (newStatus === 'new') badges.push(`<span class="inline-block bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded shrink-0">New Arrival</span>`);
                                    else if (newStatus === 'recent') badges.push(`<span class="inline-block bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded shrink-0">Recently Added</span>`);
                                    if (p.originalPrice && p.originalPrice > p.price) badges.push(`<span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded shrink-0">On Sale</span>`);
                                    else if (p.sellerTag) badges.push(`<span class="inline-block bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shrink-0">${p.sellerTag}</span>`);
                                    return badges.join(' ');
                                })()}
                            </div>
                            <div id="product-rating-display" class="flex items-center mb-4">
                                <div class="flex gap-x-1">${generateStars(p.rating)}</div>
                                <span id="reviews-count-display" class="text-sm text-stone-500 ml-2">(${p.reviewsCount} reviews)</span>
                            </div>
                            <p class="text-stone-600 mb-6 leading-relaxed">${p.description}</p>
                            <div class="flex items-baseline mb-6">
                                <span class="text-3xl font-bold text-stone-900">₹${p.price}</span>
                                ${p.originalPrice ? `<span class="text-sm text-stone-500 line-through ml-2">M.R.P: ₹${p.originalPrice}</span><span class="text-sm text-green-700 font-semibold ml-2">(${discount}% off)</span>` : ''}
                            </div>
                            
                            <div class="cart-controls-detail mt-auto" data-product-id="${p.id}">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <h2 class="text-3xl font-bold text-stone-800 mb-6">Customer Reviews</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
                        <div id="review-summary-section" class="lg:col-span-1">
                            <!-- Review summary will be injected here -->
                        </div>
                        <div class="lg:col-span-2">
                            <div id="review-highlights-section" class="mb-8">
                                <!-- Review highlights will be injected here -->
                            </div>

                            <div id="add-review-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
                                <h3 class="text-xl font-semibold text-stone-700 mb-4">Leave a Review</h3>
                                <form id="review-form" class="space-y-4">
                                    <div>
                                        <label for="reviewer-name" class="block text-sm font-medium text-stone-600">Your Name</label>
                                        <input type="text" id="reviewer-name" required class="mt-1 block w-full border border-stone-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-stone-600">Your Rating</label>
                                        <div id="review-stars" class="flex space-x-1 mt-1 text-stone-300">
                                        ${[1,2,3,4,5].map(i => `<svg data-value="${i}" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 cursor-pointer hover:text-amber-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`).join('')}
                                        </div>
                                        <input type="hidden" id="review-rating" value="0" required>
                                    </div>
                                    <div>
                                        <label for="review-comment" class="block text-sm font-medium text-stone-600">Your Comment</label>
                                        <textarea id="review-comment" rows="4" required class="mt-1 block w-full border border-stone-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                                    </div>
                                    <button type="submit" class="bg-green-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-800 transition-colors">Submit Review</button>
                                </form>
                            </div>

                            <div id="review-controls" class="flex flex-col sm:flex-row justify-between items-baseline gap-4 mb-6">
                                <div id="filter-by-stars" class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-stone-600">Filter by:</span>
                                    <div class="flex flex-wrap gap-2">
                                        ${[5,4,3,2,1].map(s => `<button data-star="${s}" class="star-filter-btn flex items-center gap-1 text-sm px-3 py-1 border border-stone-300 rounded-full hover:bg-stone-100 transition-colors">${s} <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></button>`).join('')}
                                    </div>
                                </div>
                                <select id="sort-reviews" class="text-sm font-medium bg-white border border-stone-300 rounded-md focus:ring-green-500 focus:border-green-500 p-2 cursor-pointer">
                                    <option value="newest">Sort by: Newest</option>
                                    <option value="oldest">Sort by: Oldest</option>
                                    <option value="highest">Sort by: Highest Rating</option>
                                    <option value="lowest">Sort by: Lowest Rating</option>
                                </select>
                            </div>
                            <div id="reviews-list" class="space-y-6">
                                <!-- Reviews will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <h2 class="text-2xl font-bold text-stone-800 mb-6">You Might Also Like</h2>
                    <div id="related-products-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
                </div>
                `;
                
                updateCartControls(p);
                renderReviewSummary(p, comments);
                renderReviewHighlights(comments);
                renderReviews();
                renderRelatedProducts(p);
                setupEventListeners(p);
            }
            
            function updateCartControls(p) {
                const controlsContainer = document.querySelector(`.cart-controls-detail[data-product-id="${p.id}"]`);
                if (!controlsContainer) return;
                
                if (p.inCart) {
                     controlsContainer.innerHTML = `
                        <label class="font-medium text-stone-700 mb-2 block">Quantity:</label>
                        <div class="flex items-center justify-between font-bold text-lg rounded-lg border-2 border-stone-200 bg-stone-100 max-w-xs">
                           <button class="quantity-change-btn text-green-700 px-5 py-3 rounded-l-md hover:bg-stone-200 active:bg-stone-300" data-change="-1">-</button>
                           <span class="text-green-700">${p.quantity} in cart</span>
                           <button class="quantity-change-btn text-green-700 px-5 py-3 rounded-r-md hover:bg-stone-200 active:bg-stone-300" data-change="1">+</button>
                        </div>
                    `;
                } else {
                     controlsContainer.innerHTML = `<button class="add-to-cart-btn w-full max-w-xs text-center bg-amber-500 text-stone-900 font-bold py-4 px-8 rounded-lg text-lg hover:bg-amber-600 active:bg-amber-700 transition-colors shadow-lg">Add to Cart</button>`;
                }
            }

            function renderReviewSummary(product, comments) {
                const summaryContainer = document.getElementById('review-summary-section');
                if (!summaryContainer) return;

                const totalReviews = comments.length;
                const averageRating = product.rating || 0;

                const ratingCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
                comments.forEach(c => {
                    if (ratingCounts[c.rating] !== undefined) {
                        ratingCounts[c.rating]++;
                    }
                });

                summaryContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md sticky top-24">
                        <h3 class="text-lg font-bold text-stone-800 mb-2">Overall Rating</h3>
                        <div class="flex items-center mb-4">
                            <span class="text-4xl font-bold text-stone-800">${averageRating.toFixed(1)}</span>
                            <div class="ml-4">
                                <div class="flex gap-x-1">${generateStars(Math.round(averageRating))}</div>
                                <p class="text-sm text-stone-500">Based on ${totalReviews} reviews</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${[5, 4, 3, 2, 1].map(star => {
                                const count = ratingCounts[star];
                                const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
                                return `
                                    <div class="flex items-center text-sm">
                                        <span class="text-stone-600 w-12">${star} star</span>
                                        <div class="w-full bg-stone-200 rounded-full h-2.5 mx-2">
                                            <div class="bg-amber-400 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                        <span class="text-stone-600 font-medium w-8 text-right">${count}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            function renderReviewHighlights(comments) {
                const highlightsContainer = document.getElementById('review-highlights-section');
                if (!highlightsContainer || comments.length < 2) {
                    if(highlightsContainer) highlightsContainer.style.display = 'none';
                    return;
                }

                let positiveReview = comments.reduce((prev, current) => (prev.rating > current.rating) ? prev : current);
                
                const criticalComments = comments.filter(c => c.rating < 4);
                let criticalReview = null;
                if (criticalComments.length > 0) {
                    // Find the most critical review only if critical comments exist
                    criticalReview = criticalComments.reduce((prev, current) => (prev.rating < current.rating) ? prev : current);
                }

                if (criticalReview && criticalReview._id === positiveReview._id) {
                    criticalReview = null; // Don't show the same review twice
                }

                function createHighlightCard(review, title, icon, colorClass) {
                    if (!review) return '';
                    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(review.username)}&background=random&color=fff&rounded=true`;
                    const shortComment = review.comment.length > 150 ? review.comment.substring(0, 147) + '...' : review.comment;
                    return `
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${colorClass}">
                            <div class="flex items-center mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                                <h4 class="font-bold text-stone-800">${title}</h4>
                            </div>
                            <div class="flex items-center mb-2">
                                <img src="${avatarUrl}" alt="${review.username}" class="w-6 h-6 mr-2">
                                <span class="text-sm font-semibold text-stone-700">${review.username}</span>
                            </div>
                            <p class="text-sm text-stone-600 italic">"${shortComment}"</p>
                        </div>
                    `;
                }

                highlightsContainer.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${createHighlightCard(positiveReview, 'Most Positive Review', 'trending-up', 'border-green-500')}
                        ${createHighlightCard(criticalReview, 'Most Critical Review', 'trending-down', 'border-amber-500')}
                    </div>
                `;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({ nodes: highlightsContainer.querySelectorAll('[data-lucide]') });
                }
            }
            
            function renderReviews() {
                const reviewsList = document.getElementById('reviews-list');
                let commentsToRender = [...allComments];

                // Apply star filters
                if (activeStarFilters.length > 0) {
                    commentsToRender = commentsToRender.filter(c => activeStarFilters.includes(c.rating));
                }

                // Apply sorting
                if (currentSort === 'newest') commentsToRender.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                else if (currentSort === 'oldest') commentsToRender.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                else if (currentSort === 'highest') commentsToRender.sort((a, b) => b.rating - a.rating);
                else if (currentSort === 'lowest') commentsToRender.sort((a, b) => a.rating - b.rating);

                if (!commentsToRender || commentsToRender.length === 0) {
                    reviewsList.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md text-center"><p class="text-stone-500">No reviews yet. Be the first to review this product!</p></div>`;
                    return;
                }
                reviewsList.innerHTML = commentsToRender.map((comment, index) => {
                    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.username)}&background=random&color=fff&rounded=true`;
                    const isLong = comment.comment.length > 280;
                    const shortComment = isLong ? comment.comment.substring(0, 280) + '...' : comment.comment;
                    // Demo: Mark first review as "Verified Purchase"
                    const verifiedBadge = comment.verifiedPurchase ? `<span class="flex items-center text-xs font-bold text-green-600 ml-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>Verified Purchase</span>` : '';

                    return `
                    <div class="bg-white p-5 rounded-lg shadow-md">
                        <div class="flex items-start">
                            <img src="${avatarUrl}" alt="${comment.username}" class="w-10 h-10 mr-4">
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <h4 class="font-bold text-stone-800">${comment.username}</h4>
                                        ${verifiedBadge}
                                    </div>
                                    <span class="text-xs text-stone-500">${new Date(comment.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                                <div class="flex text-amber-500 my-1">${generateStars(comment.rating)}</div>
                                <p class="text-stone-700 leading-relaxed mt-2 comment-text">${shortComment}</p>
                                ${isLong ? `<button class="read-more-btn text-green-700 font-semibold text-sm mt-1 hover:underline">Read More</button>` : ''}
                                <div class="mt-3 pt-3 border-t border-stone-200 flex items-center gap-4">
                                    <button class="helpful-btn flex items-center gap-2 text-sm text-stone-600 hover:text-green-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88Z"/></svg>
                                        <span>Helpful</span>
                                        <span class="helpful-count text-xs">(0)</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function renderRelatedProducts(currentProduct) {
                const relatedGrid = document.getElementById('related-products-grid');
                if (!relatedGrid) return;

                if (!currentProduct || !Array.isArray(currentProduct.category) || currentProduct.category.length === 0) {
                    relatedGrid.parentElement.style.display = 'none';
                    return;
                }

                const currentProductId = currentProduct.id;
                const currentCategories = currentProduct.category;

                let related = products.filter(p => 
                    p.id !== currentProductId && 
                    Array.isArray(p.category) && 
                    p.category.some(cat => currentCategories.includes(cat))
                );

                const needed = 4 - related.length;
                if (needed > 0) {
                    const relatedIds = new Set(related.map(p => p.id));
                    relatedIds.add(currentProductId);
                    const otherProducts = products.filter(p => !relatedIds.has(p.id));
                    const shuffledOthers = otherProducts.sort(() => 0.5 - Math.random());
                    related = related.concat(shuffledOthers.slice(0, needed));
                }

                const finalRelated = related.sort(() => 0.5 - Math.random()).slice(0, 4);
                if (finalRelated.length === 0) {
                    relatedGrid.parentElement.style.display = 'none';
                    return;
                }
                
                relatedGrid.parentElement.style.display = 'block';

                relatedGrid.innerHTML = finalRelated.map(product => {
                    const imageUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/400x300/CCCCCC/FFFFFF?text=No+Image';
                    return `
                        <a href="product-detail.html?id=${product.id}" class="block bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 group">
                            <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="font-medium text-sm text-stone-800 leading-tight mb-2 group-hover:text-green-700 transition-colors">${product.name}</h3>
                                <div class="flex items-baseline">
                                    <span class="text-xl font-bold text-stone-800">₹${product.price}</span>
                                    ${product.originalPrice ? `<span class="text-sm text-stone-500 line-through ml-2">₹${product.originalPrice}</span>` : ''}
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');
            }

            function setupEventListeners(p) {
                const thumbnails = document.querySelectorAll('#thumbnail-gallery img');
                const mainImage = document.getElementById('main-product-image');
                thumbnails.forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        mainImage.src = thumb.src;
                        thumbnails.forEach(t => t.classList.remove('border-green-700'));
                        thumb.classList.add('border-green-700');
                    });
                });

                const controlsContainer = document.querySelector('.cart-controls-detail');
                controlsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.add-to-cart-btn');
                    const quantityButton = e.target.closest('.quantity-change-btn');

                    if (button && !button.disabled) {
                        button.disabled = true;
                        button.innerHTML = `<div class="spinner"></div>`;
                        button.classList.add('flex', 'justify-center', 'items-center');

                        setTimeout(() => {
                            p.inCart = true;
                            p.quantity = 1;
                            showNotification(`"${p.name.substring(0, 30)}..." added to cart!`);
                            updateCartControls(p);
                            updateCartCount();
                            saveProductsToStorage();
                        }, 500);
                    } else if (quantityButton) {
                        const change = parseInt(quantityButton.dataset.change);
                        p.quantity += change;
                        if (p.quantity <= 0) {
                            p.inCart = false;
                            p.quantity = 0;
                        }
                        updateCartControls(p);
                        updateCartCount();
                        saveProductsToStorage();
                    }
                });

                // --- NEW: Event Listeners for Sort and Filter ---
                const sortSelect = document.getElementById('sort-reviews');
                sortSelect.addEventListener('change', (e) => {
                    currentSort = e.target.value;
                    renderReviews();
                });

                const filterContainer = document.getElementById('filter-by-stars');
                filterContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.star-filter-btn');
                    if (!button) return;

                    const star = parseInt(button.dataset.star);
                    button.classList.toggle('bg-green-700');
                    button.classList.toggle('text-white');
                    button.classList.toggle('border-green-700');

                    const index = activeStarFilters.indexOf(star);
                    if (index > -1) {
                        activeStarFilters.splice(index, 1);
                    } else {
                        activeStarFilters.push(star);
                    }
                    renderReviews();
                });

                const reviewsList = document.getElementById('reviews-list');
                reviewsList.addEventListener('click', e => {
                    const readMoreBtn = e.target.closest('.read-more-btn');
                    const helpfulBtn = e.target.closest('.helpful-btn');

                    if (readMoreBtn) {
                        const commentCard = readMoreBtn.closest('.bg-white');
                        commentCard.querySelector('.comment-text').classList.toggle('whitespace-pre-wrap');
                        readMoreBtn.textContent = readMoreBtn.textContent === 'Read More' ? 'Read Less' : 'Read More';
                    } else if (helpfulBtn && !helpfulBtn.classList.contains('text-green-700')) {
                        helpfulBtn.classList.add('text-green-700', 'font-semibold');
                        const countEl = helpfulBtn.querySelector('.helpful-count');
                        countEl.textContent = `(${parseInt(countEl.textContent.slice(1, -1)) + 1})`;
                    }
                });

                const reviewStarsContainer = document.getElementById('review-stars');
                const reviewStars = reviewStarsContainer.querySelectorAll('svg');
                const ratingInput = document.getElementById('review-rating');
                let currentRating = 0;

                function updateStarDisplay(rating) {
                    reviewStars.forEach(s => {
                        const starValue = parseInt(s.dataset.value);
                        s.classList.toggle('text-amber-400', starValue <= rating);
                        s.classList.toggle('text-stone-300', starValue > rating);
                    });
                }

                reviewStars.forEach(star => {
                    star.addEventListener('mouseover', () => updateStarDisplay(star.dataset.value));
                    star.addEventListener('click', () => {
                        currentRating = parseInt(star.dataset.value);
                        ratingInput.value = currentRating;
                        updateStarDisplay(currentRating);
                    });
                });
                
                reviewStarsContainer.addEventListener('mouseleave', () => updateStarDisplay(currentRating));

                // --- **FIX 2:** CORRECTED REVIEW FORM SUBMISSION ---
                const reviewForm = document.getElementById('review-form');
                reviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = reviewForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;

                    const newReview = {
                        user: document.getElementById('reviewer-name').value,
                        rating: parseInt(ratingInput.value),
                        comment: document.getElementById('review-comment').value
                    };
                    
                    if (!newReview.user || !newReview.rating || !newReview.comment) {
                        alert("Please fill out all fields and select a rating.");
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.innerHTML = `<span class="spinner"></span> Submitting...`;

                    try {
                        const response = await fetch(`/api/products/${p.id}/reviews`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newReview),
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({})); // Handle non-json error responses
                            throw new Error(errorData.error || `Server responded with status ${response.status}`);
                        }
                        
                        const result = await response.json();
                        const { newComment, newRating, newReviewsCount } = result;
                        
                        // Update product object in local state
                        product.rating = newRating;
                        product.reviewsCount = newReviewsCount;

                        // Fetch all comments again to update the summary correctly
                        const commentsResponse = await fetch(`/api/comments/${product._id}`);
                        if (!commentsResponse.ok) {
                            console.error('Failed to re-fetch comments after submission.');
                            // Fallback to just adding the new comment
                            allComments.unshift(newComment);
                            renderReviews();
                        } else {
                            const updatedCommentsData = await commentsResponse.json();
                            const updatedComments = Array.isArray(updatedCommentsData) ? updatedCommentsData : (updatedCommentsData.comments || []);
                            allComments = updatedComments;
                            // Update UI instantly
                            renderReviewSummary(product, updatedComments); // Re-render the summary
                            renderReviewHighlights(updatedComments);
                            renderReviews(); // Re-render the reviews list
                        }

                        // Reset form and rating state
                        reviewForm.reset();
                        currentRating = 0;
                        ratingInput.value = 0;
                        updateStarDisplay(currentRating);

                    } catch (error) {
                        console.error("Review submission error:", error);
                        alert(`There was a problem submitting your review: ${error.message}`);
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    }
                });
            }

            window.addEventListener('storage', (event) => {
                if (event.key === 'goshalaProducts') {
                    loadProducts(true).then(newProducts => {
                        products = newProducts;
                        product = products.find(p => p.id === productId);
                        if (product) {
                            updateCartControls(product);
                        }
                    });
                    updateCartCount();
                }
            });

            function updateCartCount() {
                const itemsInCart = products.filter(p => p.inCart).length;
                cartCountElement.textContent = itemsInCart;
            }

            let notificationTimeout;
            function showNotification(message) {
                const notification = document.getElementById('cart-notification');
                const messageElement = document.getElementById('notification-message');
                if (!notification || !messageElement) return;
                messageElement.textContent = message;
                clearTimeout(notificationTimeout);
                notification.classList.remove('translate-y-20', 'opacity-0');
                notificationTimeout = setTimeout(() => notification.classList.add('translate-y-20', 'opacity-0'), 3000);
            }

            function generateStars(rating) {
                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    starsHTML += `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star ${i <= rating ? 'fill-amber-500 stroke-amber-500 text-amber-500' : 'fill-stone-200 stroke-stone-300 text-stone-300'}"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;
                }
                return starsHTML;
            }

            // --- INITIAL SETUP ---
            updateCartCount();
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            }
            
        });

        // --- PAGE LOADER LOGIC ---
        const pageLoader = document.getElementById('page-loader');
        window.addEventListener('load', () => {
            if (pageLoader) {
                pageLoader.classList.add('opacity-0');
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 300);
            }
        });
        window.addEventListener('beforeunload', () => {
            if (pageLoader) {
                pageLoader.style.display = 'flex';
            }
        });
    </script>

</body>
</html>