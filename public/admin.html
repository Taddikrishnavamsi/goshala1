<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Brundavanam Goshala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/png" href="/logo.png">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .spinner { width: 20px; height: 20px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: spin 0.75s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .dragover { border-color: #16a34a; background-color: #f0fdf4; }
        .thumbnail-container { position: relative; }
        .dragging { opacity: 0.5; }
        .thumbnail-remove-btn { position: absolute; top: -8px; right: -8px; background-color: #ef4444; color: white; border-radius: 9999px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .thumbnail-container:hover .thumbnail-remove-btn { opacity: 1; }
    </style>
</head>
<body class="bg-stone-100">

    <!-- Auth Gate -->
    <div id="auth-gate" class="fixed inset-0 z-50 flex items-center justify-center bg-stone-200">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h1 class="text-2xl font-bold text-stone-800 mb-2">Admin Access</h1>
            <p class="text-stone-500 mb-6">Please enter the admin secret key to proceed.</p>
            <form id="auth-form">
                <input type="password" id="admin-secret-input" placeholder="Secret Key" class="w-full p-3 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600 mb-4">
                <button type="submit" class="w-full bg-green-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-800 transition-colors">
                    Authenticate
                </button>
                <p id="auth-error" class="text-red-600 text-sm mt-4 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Main Dashboard (hidden by default) -->
    <div id="dashboard-main" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="index.html" class="text-xl font-bold text-green-800">Brundavanam Goshala</a>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-stone-600">Admin Panel</span>
                        <button id="logout-btn" class="text-sm text-red-600 hover:underline">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold text-stone-800 mb-6">Dashboard</h1>

            <!-- Dashboard Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Revenue -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-sm font-medium text-stone-500">Total Revenue</h3>
                    <p id="stats-total-revenue" class="text-3xl font-bold text-stone-800 mt-2"><span class="spinner"></span></p>
                </div>
                <!-- Total Orders -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-sm font-medium text-stone-500">Total Orders</h3>
                    <p id="stats-total-orders" class="text-3xl font-bold text-stone-800 mt-2"><span class="spinner"></span></p>
                </div>
                <!-- Recent Orders -->
                <div class="bg-white p-6 rounded-lg shadow-md md:col-span-2">
                    <h3 class="text-sm font-medium text-stone-500 mb-3">Recent Orders</h3>
                    <div id="stats-recent-orders" class="space-y-2">
                        <div class="flex justify-center items-center p-4"><span class="spinner"></span></div>
                    </div>
                </div>
                <!-- Top Selling Products -->
                <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-4">
                    <h3 class="text-sm font-medium text-stone-500 mb-3">Top Selling Products</h3>
                    <div id="stats-top-products" class="space-y-2">
                         <div class="flex justify-center items-center p-4"><span class="spinner"></span></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6 mt-12">
                <h2 class="text-2xl font-bold text-stone-800">Order Management</h2>
                <a href="/api/admin/orders/export" id="export-orders-btn" target="_blank" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>Export All</span>
                </a>
            </div>

            <!-- Orders Search and Table -->
            <div class="mb-4">
                <div class="relative w-full max-w-md">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"><i data-lucide="search" class="w-4 h-4 text-stone-500"></i></div>
                    <input type="text" id="order-search-input" class="block w-full p-2 ps-10 text-sm text-stone-900 border border-stone-300 rounded-lg bg-stone-50 focus:ring-blue-500 focus:border-blue-500" placeholder="Search by Order ID, Name, or Email...">
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="w-full text-sm text-left text-stone-600">
                    <thead class="text-xs text-stone-700 uppercase bg-stone-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">Order ID</th>
                            <th scope="col" class="px-6 py-3">Customer</th>
                            <th scope="col" class="px-6 py-3">Date</th>
                            <th scope="col" class="px-6 py-3">Total</th>
                            <th scope="col" class="px-6 py-3">Shipping Status</th>
                            <th scope="col" class="px-6 py-3"><span class="sr-only">Details</span></th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body"><tr><td colspan="5" class="text-center p-8"><div class="spinner mx-auto"></div></td></tr></tbody>
                </table>
                <nav id="order-pagination-controls" class="flex items-center justify-between pt-4" aria-label="Table navigation"></nav>
            </div>

            <!-- Carousel Management Section -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Homepage Carousel Management</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-stone-600 mb-4">Select up to 5 products to display in the homepage carousel. Search for products by name or ID below.</p>
                    <div class="relative">
                        <input type="text" id="carousel-product-search" placeholder="Search for products to add..." class="w-full p-3 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        <div id="carousel-search-results" class="absolute z-10 w-full bg-white border border-stone-300 rounded-md mt-1 shadow-lg hidden max-h-60 overflow-y-auto"></div>
                    </div>
                    <div id="carousel-selected-products" class="mt-4 space-y-2">
                        <!-- Selected products will be shown here -->
                    </div>
                    <button id="save-carousel-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">Save Carousel</button>
                </div>
            </div>

            <!-- Top Picks Management Section -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Homepage "Top Picks" Management</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-stone-600 mb-4">Select up to 4 products to display in the "Top Picks" section on the homepage. Search for products by name or ID.</p>
                    <div class="relative">
                        <input type="text" id="top-picks-search" placeholder="Search for products to add..." class="w-full p-3 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        <div id="top-picks-search-results" class="absolute z-10 w-full bg-white border border-stone-300 rounded-md mt-1 shadow-lg hidden max-h-60 overflow-y-auto"></div>
                    </div>
                    <div id="top-picks-selected-products" class="mt-4 space-y-2">
                        <!-- Selected products will be shown here -->
                    </div>
                    <button id="save-top-picks-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">Save Top Picks</button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6 mt-12">
                <h2 class="text-2xl font-bold text-stone-800">Product Management</h2>
                <button id="add-product-btn" class="bg-green-700 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-800 transition-colors flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Add New Product</span>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <div class="relative w-full max-w-md">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none"><i data-lucide="search" class="w-4 h-4 text-stone-500"></i></div>
                    <input type="text" id="admin-search-input" class="block w-full p-2 ps-10 text-sm text-stone-900 border border-stone-300 rounded-lg bg-stone-50 focus:ring-green-500 focus:border-green-500" placeholder="Search by Product Name or ID...">
                </div>
            </div>

            <!-- Products Table -->
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="w-full text-sm text-left text-stone-600">
                    <thead class="text-xs text-stone-700 uppercase bg-stone-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">ID</th>
                            <th scope="col" class="px-6 py-3">Product Name</th>
                            <th scope="col" class="px-6 py-3">Price</th>
                            <th scope="col" class="px-6 py-3">Category</th>
                            <th scope="col" class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <!-- Rows will be injected here -->
                        <tr><td colspan="5" class="text-center p-8"><div class="spinner mx-auto"></div></td></tr>
                    </tbody>
                </table>
                <!-- Pagination Controls -->
                <nav id="pagination-controls" class="flex items-center justify-between pt-4" aria-label="Table navigation">
                    <span class="text-sm font-normal text-stone-500">Showing <span id="pagination-info" class="font-semibold text-stone-900">1-10 of 100</span></span>
                    <ul id="pagination-list" class="inline-flex -space-x-px text-sm h-8">
                    </ul>
                </table>
            </div>
        </main>
    </div>

    <!-- Product Add/Edit Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden items-start justify-center bg-black/60 backdrop-blur-sm p-4 overflow-y-auto">
        <div id="product-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-3xl my-8 modal-content transform scale-95 opacity-0">
            <form id="product-form">
                <div class="flex justify-between items-center p-6 border-b">
                    <h2 id="modal-title" class="text-2xl font-bold text-stone-800">Add New Product</h2>
                    <button type="button" id="modal-close-btn" class="p-1 rounded-full hover:bg-stone-200">
                        <i data-lucide="x" class="w-6 h-6 text-stone-600"></i>
                    </button>
                </div>

                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="product-db-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-legacyId" class="block text-sm font-medium text-stone-700 mb-1">Product ID (Unique)</label>
                            <input type="number" id="product-legacyId" required class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        </div>
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-stone-700 mb-1">Product Name</label>
                            <input type="text" id="product-name" required class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        </div>
                    </div>

                    <div>
                        <label for="product-description" class="block text-sm font-medium text-stone-700 mb-1">Description</label>
                        <textarea id="product-description" rows="3" class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-stone-700 mb-1">Price (₹)</label>
                            <input type="number" id="product-price" step="0.01" required class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        </div>
                        <div>
                            <label for="product-originalPrice" class="block text-sm font-medium text-stone-700 mb-1">Original Price (₹, Optional)</label>
                            <input type="number" id="product-originalPrice" step="0.01" class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        </div>
                    </div>

                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="product-category" class="block text-sm font-medium text-stone-700 mb-1">Categories (comma-separated)</label>
                            <input type="text" id="product-category" class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        </div>
                        <div>
                            <label for="product-sellerTag" class="block text-sm font-medium text-stone-700 mb-1">Seller Tag (e.g., Best Seller)</label>
                            <input type="text" id="product-sellerTag" class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                        </div>
                    </div>

                    <div>
                        <label for="product-deliveryDate" class="block text-sm font-medium text-stone-700 mb-1">Delivery Info (e.g., Delivery by Tomorrow)</label>
                        <input type="text" id="product-deliveryDate" class="w-full p-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-green-600">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Product Images</label>
                        <div id="image-dropzone" class="border-2 border-dashed border-stone-300 rounded-lg p-6 text-center cursor-pointer hover:border-green-600 transition-colors">
                            <p class="text-stone-500">Drag & drop images here, or click to select files</p>
                            <input type="file" id="image-upload-input" multiple accept="image/*" class="hidden">
                        </div>
                        <div id="image-previews" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                            <!-- Image previews will be injected here -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-end items-center p-6 border-t bg-stone-50 rounded-b-lg">
                    <p id="form-status" class="text-sm font-medium mr-auto"></p>
                    <button type="button" id="modal-cancel-btn" class="bg-stone-200 text-stone-800 font-bold py-2 px-5 rounded-lg hover:bg-stone-300 mr-3">Cancel</button>
                    <button type="submit" id="form-submit-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { loadProducts, ApiError } from '/js/data.js';

        // --- STATE ---
        let adminSecret = sessionStorage.getItem('goshalaAdminSecret');
        let allProducts = [];
        let currentEditingProduct = null;
        let uploadedImageUrls = [];
        let currentPage = 1;
        const productsPerPage = 10;
        let currentOrderPage = 1;
        const ordersPerPage = 10;
        let orderSearchQuery = '';
        let totalOrderPages = 1;

        let searchQuery = '';
        let totalPages = 1;
        let activeUploads = 0;


        // --- DOM ELEMENTS ---
        const authGate = document.getElementById('auth-gate');
        const dashboardMain = document.getElementById('dashboard-main');
        const authForm = document.getElementById('auth-form');
        const secretInput = document.getElementById('admin-secret-input');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const productsTableBody = document.getElementById('products-table-body');
        const addProductBtn = document.getElementById('add-product-btn');
        
        // Modal elements
        const productModal = document.getElementById('product-modal');
        const productModalContent = document.getElementById('product-modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const productForm = document.getElementById('product-form');
        const formSubmitBtn = document.getElementById('form-submit-btn');
        const formStatus = document.getElementById('form-status');

        // Image upload elements
        const imageDropzone = document.getElementById('image-dropzone');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviews = document.getElementById('image-previews');

        // Pagination elements
        const paginationControls = document.getElementById('pagination-controls');
        const paginationList = document.getElementById('pagination-list');
        const orderPaginationControls = document.getElementById('order-pagination-controls');
        const ordersTableBody = document.getElementById('orders-table-body');
        const orderSearchInput = document.getElementById('order-search-input');
        const exportOrdersBtn = document.getElementById('export-orders-btn');
        const adminSearchInput = document.getElementById('admin-search-input');

        // Carousel elements
        const carouselProductSearch = document.getElementById('carousel-product-search');
        const carouselSearchResults = document.getElementById('carousel-search-results');
        const carouselSelectedProducts = document.getElementById('carousel-selected-products');
        const saveCarouselBtn = document.getElementById('save-carousel-btn');

        // Top Picks elements
        const topPicksSearch = document.getElementById('top-picks-search');
        const topPicksSearchResults = document.getElementById('top-picks-search-results');
        const topPicksSelectedProducts = document.getElementById('top-picks-selected-products');
        const saveTopPicksBtn = document.getElementById('save-top-picks-btn');

        // --- API HELPERS ---
        const api = {
            async get(endpoint) {
                const res = await fetch(endpoint, { headers: { 'x-admin-secret': adminSecret } });
                if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
                return res.json();
            },
            async post(endpoint, body) {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': adminSecret },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const text = await res.text();
                    try {
                        const err = JSON.parse(text);
                        throw new Error(err.details || err.error || 'API POST Error');
                    } catch (e) {
                        throw new Error(`API POST Error: ${res.status} ${res.statusText}`);
                    }
                }
                return res.json();
            },
            async put(endpoint, body) {
                const res = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-secret': adminSecret },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const text = await res.text();
                    try {
                        const err = JSON.parse(text);
                        throw new Error(err.details || err.error || 'API PUT Error');
                    } catch (e) {
                        throw new Error(`API PUT Error: ${res.status} ${res.statusText}`);
                    }
                }
                return res.json();
            },
            async delete(endpoint) {
                const res = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: { 'x-admin-secret': adminSecret }
                });
                if (!res.ok) throw new Error(`API DELETE Error: ${res.statusText}`);
                return res.json();
            },
            async upload(file) {
                const formData = new FormData();
                formData.append('image', file);
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'x-admin-secret': adminSecret },
                    body: formData
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Upload failed');
                }
                return res.json();
            }
        };

        // --- AUTHENTICATION ---
        function checkAuth() {
            if (adminSecret) {
                authGate.style.display = 'none';
                dashboardMain.style.display = 'block';
                if (typeof initializeDashboard === 'function') {
                    initializeDashboard();
                }
            } else {
                authGate.style.display = 'flex';
                dashboardMain.style.display = 'none';
            }
        }

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const secret = secretInput.value.trim();
            if (secret) {
                sessionStorage.setItem('goshalaAdminSecret', secret);
                adminSecret = secret;
                // Simple validation by trying to fetch data
                loadProductsAdmin().then(() => {
                    checkAuth();
                }).catch(err => {
                    sessionStorage.removeItem('goshalaAdminSecret');
                    adminSecret = null;
                    authError.textContent = 'Invalid secret key or API error.';
                });
            } else {
                authError.textContent = 'Please enter a secret key.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('goshalaAdminSecret');
            adminSecret = null;
            location.reload();
        });

        // --- DASHBOARD STATS ---
        async function loadDashboardStats() {
            try {
                const stats = await api.get('/api/admin/dashboard-stats');
                
                // Total Revenue
                document.getElementById('stats-total-revenue').textContent = `₹${(stats.totalRevenue || 0).toLocaleString('en-IN')}`;
                
                // Total Orders
                document.getElementById('stats-total-orders').textContent = stats.totalOrders || 0;

                // Recent Orders
                const recentOrdersEl = document.getElementById('stats-recent-orders');
                if (stats.recentOrders && stats.recentOrders.length > 0) {
                    recentOrdersEl.innerHTML = stats.recentOrders.map(order => `
                        <div class="text-sm flex justify-between items-center">
                            <span class="text-stone-600">${order.user.firstname} ${order.user.lastname}</span>
                            <span class="font-semibold text-stone-800">₹${order.total.toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    recentOrdersEl.innerHTML = `<p class="text-sm text-stone-500 text-center">No recent orders.</p>`;
                }

                // Top Selling Products
                const topProductsEl = document.getElementById('stats-top-products');
                if (stats.topSellingProducts && stats.topSellingProducts.length > 0) {
                    topProductsEl.innerHTML = stats.topSellingProducts.map(product => `
                        <div class="text-sm flex justify-between items-center">
                            <span class="text-stone-600">${product.name}</span>
                            <span class="font-semibold text-stone-800">${product.totalQuantity} sold</span>
                        </div>
                    `).join('');
                } else {
                    topProductsEl.innerHTML = `<p class="text-sm text-stone-500 text-center">No sales data available.</p>`;
                }
            } catch (error) {
                console.error("Failed to load dashboard stats:", error);
            }
        }

        // --- ORDER MANAGEMENT ---
        async function loadOrders(page = 1, search = '') {
            currentOrderPage = page;
            ordersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8"><div class="spinner mx-auto"></div></td></tr>`;
            if (orderPaginationControls) orderPaginationControls.innerHTML = '';

            try {
                const data = await api.get(`/api/admin/orders?page=${page}&limit=${ordersPerPage}&search=${encodeURIComponent(search)}`);
                const orders = data.orders || [];
                totalOrderPages = data.totalPages || 1;

                if (orders.length === 0) {
                    ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-stone-500">No orders found for this query.</td></tr>`;
                    return;
                }

                const statusOptions = ['Pending', 'Shipped', 'Delivered', 'Cancelled'];
                const statusColors = {
                    'Pending': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                    'Shipped': 'bg-blue-100 text-blue-800 border-blue-300',
                    'Delivered': 'bg-green-100 text-green-800 border-green-300',
                    'Cancelled': 'bg-red-100 text-red-800 border-red-300',
                };

                ordersTableBody.innerHTML = orders.map(order => {
                    const fullAddress = `${order.user.address1}, ${order.user.address2 ? order.user.address2 + ', ' : ''}${order.user.city}, ${order.user.state} - ${order.user.zip}`;
                    return `
                    <tr class="border-b hover:bg-stone-50" data-order-id="${order.orderId}">
                        <td class="px-6 py-4 font-mono text-xs text-stone-700">${order.orderId}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-stone-900">${order.user.firstname} ${order.user.lastname}</div>
                            <div class="text-stone-500 text-xs">${order.user.email}</div>
                        </td>
                        <td class="px-6 py-4">${new Date(order.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 font-semibold">₹${order.total.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <select class="shipping-status-select text-xs font-medium p-1 rounded border focus:ring-blue-500 focus:border-blue-300 transition-colors ${statusColors[order.shippingStatus] || 'bg-stone-100'}" data-order-id="${order.orderId}" data-current-status="${order.shippingStatus}">
                                ${statusOptions.map(status => `<option value="${status}" ${order.shippingStatus === status ? 'selected' : ''}>${status}</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button class="toggle-details-btn p-1 rounded-full hover:bg-stone-200 cursor-pointer">
                                <i data-lucide="chevron-down" class="w-5 h-5 text-stone-500 transition-transform"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="details-row hidden bg-stone-50">
                        <td colspan="6" class="p-0">
                            <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="md:col-span-1 space-y-4">
                                    <h4 class="font-semibold text-stone-700 mb-2">Shipping Address</h4>
                                    <p class="text-stone-600">${fullAddress}</p>
                                    <p class="text-stone-600 mt-1"><b>Phone:</b> ${order.user.phone}</p>
                                    <div>
                                        <h4 class="font-semibold text-stone-700 mb-2">Tracking Details</h4>
                                        <div class="space-y-2">
                                            <input type="text" placeholder="Carrier (e.g., Delhivery)" value="${order.tracking?.carrier || ''}" class="tracking-carrier-input w-full p-1.5 border border-stone-300 rounded-md text-xs" data-order-id="${order.orderId}">
                                            <input type="text" placeholder="Tracking Number" value="${order.tracking?.number || ''}" class="tracking-number-input w-full p-1.5 border border-stone-300 rounded-md text-xs" data-order-id="${order.orderId}">
                                            <button class="save-tracking-btn bg-blue-600 text-white text-xs font-bold py-1.5 px-3 rounded-md hover:bg-blue-700" data-order-id="${order.orderId}">
                                                Save Tracking
                                            </button>
                                            <span class="tracking-status-text text-xs text-green-600 ml-2"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <h4 class="font-semibold text-stone-700 mb-2">Order Items</h4>
                                    <ul class="space-y-1 list-disc list-inside text-stone-600">
                                        ${order.items.map(item => `
                                            <li>
                                                <span class="font-medium">${item.quantity} x</span> ${item.name} 
                                                <span class="text-xs">(at ₹${item.price.toFixed(2)} each)</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                `}).join('');

                renderOrderPagination(data);

            } catch (error) {
                console.error("Failed to load orders:", error);
                ordersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-600 font-medium">Failed to load orders.</td></tr>`;
            }
        }

        function renderOrderPagination(data) {
            if (data.totalPages <= 1) {
                if (orderPaginationControls) orderPaginationControls.innerHTML = '';
                return;
            }
            const startItem = (data.currentPage - 1) * ordersPerPage + 1;
            const endItem = startItem + data.orders.length - 1;

            let paginationHTML = `<span class="text-sm font-normal text-stone-500">Showing <span class="font-semibold text-stone-900">${startItem}-${endItem} of ${data.totalOrders}</span></span><ul class="inline-flex -space-x-px text-sm h-8">`;
            paginationHTML += `<li><button data-page="${data.currentPage - 1}" class="order-pagination-btn flex items-center justify-center px-3 h-8 ms-0 leading-tight text-stone-500 bg-white border border-e-0 border-stone-300 rounded-s-lg hover:bg-stone-100 ${data.currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${data.currentPage === 1 ? 'disabled' : ''}>Prev</button></li>`;
            for (let i = 1; i <= data.totalPages; i++) {
                if (i === data.currentPage) {
                    paginationHTML += `<li><button aria-current="page" class="flex items-center justify-center px-3 h-8 text-blue-600 border border-stone-300 bg-blue-50">${i}</button></li>`;
                } else {
                    paginationHTML += `<li><button data-page="${i}" class="order-pagination-btn flex items-center justify-center px-3 h-8 leading-tight text-stone-500 bg-white border border-stone-300 hover:bg-stone-100">${i}</button></li>`;
                }
            }
            paginationHTML += `<li><button data-page="${data.currentPage + 1}" class="order-pagination-btn flex items-center justify-center px-3 h-8 leading-tight text-stone-500 bg-white border border-stone-300 rounded-e-lg hover:bg-stone-100 ${data.currentPage === data.totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${data.currentPage === data.totalPages ? 'disabled' : ''}>Next</button></li>`;
            paginationHTML += `</ul>`;
            if (orderPaginationControls) orderPaginationControls.innerHTML = paginationHTML;
        }


        // --- DASHBOARD LOGIC ---
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        async function loadProductsAdmin(page = 1, search = '') {
            currentPage = page;
            productsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8"><div class="spinner mx-auto"></div></td></tr>`;
            paginationControls.classList.add('hidden');
            try {
                const data = await api.get(`/api/products?page=${page}&limit=${productsPerPage}&search=${encodeURIComponent(search)}`);
                allProducts = data.products || [];
                totalPages = data.totalPages || 1;
                renderProductsTable(data);
            } catch (error) {
                console.error("Failed to load products:", error);
                productsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-600 font-medium">Failed to load products. Check console for errors.</td></tr>`;
            }
        }

        function renderProductsTable(data) {
            if (allProducts.length === 0) {
                productsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-stone-500">No products found.</td></tr>`;
                return;
            }
            productsTableBody.innerHTML = allProducts.map(p => `
                <tr class="border-b hover:bg-stone-50">
                    <td class="px-6 py-4 font-medium text-stone-900">${p.id}</td>
                    <td class="px-6 py-4 flex items-center gap-3">
                        <img src="${(p.images && p.images[0]) || 'https://placehold.co/40x40'}" alt="${p.name}" class="w-10 h-10 object-cover rounded-md">
                        <span>${p.name}</span>
                    </td>
                    <td class="px-6 py-4">₹${p.price}</td>
                    <td class="px-6 py-4">${(p.category || []).join(', ')}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="edit-btn font-medium text-blue-600 hover:underline mr-4" data-id="${p.id}">Edit</button>
                        <button class="delete-btn font-medium text-red-600 hover:underline" data-id="${p.id}">Delete</button>
                    </td>
                </tr>
            `).join('');
            renderPagination(data);
        }

        function renderPagination(data) {
            if (totalPages <= 1) {
                paginationControls.classList.add('hidden');
                return;
            }
            paginationControls.classList.remove('hidden');

            let paginationHTML = '';
            // Previous button
            paginationHTML += `<li><button data-page="${currentPage - 1}" class="pagination-btn flex items-center justify-center px-3 h-8 ms-0 leading-tight text-stone-500 bg-white border border-e-0 border-stone-300 rounded-s-lg hover:bg-stone-100 hover:text-stone-700 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>Previous</button></li>`;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<li><button aria-current="page" class="pagination-btn flex items-center justify-center px-3 h-8 text-blue-600 border border-stone-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700">${i}</button></li>`;
                } else {
                    paginationHTML += `<li><button data-page="${i}" class="pagination-btn flex items-center justify-center px-3 h-8 leading-tight text-stone-500 bg-white border border-stone-300 hover:bg-stone-100 hover:text-stone-700">${i}</button></li>`;
                }
            }

            // Next button
            paginationHTML += `<li><button data-page="${currentPage + 1}" class="pagination-btn flex items-center justify-center px-3 h-8 leading-tight text-stone-500 bg-white border border-stone-300 rounded-e-lg hover:bg-stone-100 hover:text-stone-700 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>Next</button></li>`;

            paginationList.innerHTML = paginationHTML;
            // Update the "Showing X-Y of Z" text
            const startItem = (currentPage - 1) * productsPerPage + 1;
            const endItem = startItem + allProducts.length - 1;
            document.getElementById('pagination-info').textContent = `${startItem}-${endItem} of ${data.totalProducts}`;
        }

        paginationList.addEventListener('click', (e) => {
            const button = e.target.closest('.pagination-btn');
            if (button && button.dataset.page) {
                const newPage = parseInt(button.dataset.page);
                if (newPage !== currentPage) {
                    loadProductsAdmin(newPage, searchQuery);
                }
            }
        });

        orderPaginationControls?.addEventListener('click', (e) => {
            const button = e.target.closest('.order-pagination-btn');
            if (button && button.dataset.page) {
                const newPage = parseInt(button.dataset.page);
                if (newPage !== currentOrderPage) {
                    loadOrders(newPage, orderSearchQuery);
                }
            }
        });

        ordersTableBody.addEventListener('click', (e) => {
            // Don't toggle if the click was on the status dropdown
            if (e.target.closest('.shipping-status-select, .save-tracking-btn, .tracking-carrier-input, .tracking-number-input')) {
                return;
            }

            const row = e.target.closest('tr[data-order-id]');
            if (row) {
                const detailsRow = row.nextElementSibling;
                detailsRow.classList.toggle('hidden');
                row.querySelector('.toggle-details-btn i').classList.toggle('rotate-180');
            }
        });

        ordersTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('save-tracking-btn')) {
                const button = e.target;
                const orderId = button.dataset.orderId;
                const row = button.closest('.details-row');
                const trackingNumber = row.querySelector(`.tracking-number-input[data-order-id="${orderId}"]`).value;
                const trackingCarrier = row.querySelector(`.tracking-carrier-input[data-order-id="${orderId}"]`).value;
                const statusText = row.querySelector('.tracking-status-text');

                button.disabled = true;
                button.textContent = 'Saving...';
                statusText.textContent = '';

                try {
                    await api.put(`/api/admin/orders/${orderId}/status`, { trackingNumber, trackingCarrier });
                    statusText.textContent = 'Saved!';
                } catch (error) {
                    console.error('Failed to save tracking:', error);
                    statusText.textContent = 'Error!';
                    statusText.classList.replace('text-green-600', 'text-red-600');
                } finally {
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = 'Save Tracking';
                        statusText.textContent = '';
                        statusText.classList.replace('text-red-600', 'text-green-600');
                    }, 2000);
                }
            }
        });

        ordersTableBody.addEventListener('change', async (e) => {
            if (e.target.classList.contains('shipping-status-select')) {
                const select = e.target;
                const orderId = select.dataset.orderId;
                const newStatus = select.value;

                try {
                    await api.put(`/api/admin/orders/${orderId}/status`, { status: newStatus });
                    // On success, reload orders to reflect changes consistently
                    loadOrders(currentOrderPage, orderSearchQuery);
                } catch (error) {
                    console.error('Failed to update status:', error);
                    alert(`Error: ${error.message}`);
                }
            }
        });

        const debouncedOrderSearch = debounce((value) => {
            orderSearchQuery = value;
            if (exportOrdersBtn) exportOrdersBtn.href = `/api/admin/orders/export?search=${encodeURIComponent(orderSearchQuery)}`;
            loadOrders(1, orderSearchQuery);
        }, 300);
        orderSearchInput?.addEventListener('input', (e) => debouncedOrderSearch(e.target.value));

        const debouncedSearch = debounce((value) => {
            searchQuery = value;
            loadProductsAdmin(1, searchQuery); // Reset to page 1 on new search
        }, 300);
        adminSearchInput.addEventListener('input', (e) => debouncedSearch(e.target.value));

        // --- CAROUSEL MANAGEMENT ---
        let carouselProductIds = [];
        let carouselProductCache = {};

        async function loadCarouselConfig() {
            try {
                carouselProductIds = await api.get('/api/admin/config/carousel');
                const productsToFetch = carouselProductIds.filter(id => !carouselProductCache[id]);
                if (productsToFetch.length > 0) {
                    for (const id of productsToFetch) {
                        carouselProductCache[id] = await api.get(`/api/products/${id}`);
                    }
                }
                renderSelectedCarouselProducts();
            } catch (error) {
                console.error('Error loading carousel config:', error);
            }
        }

        function renderSelectedCarouselProducts() {
            carouselSelectedProducts.innerHTML = '';
            if (carouselProductIds.length === 0) {
                carouselSelectedProducts.innerHTML = '<p class="text-stone-500">No products selected for the carousel.</p>';
                return;
            }

            carouselProductIds.forEach(id => {
                const product = carouselProductCache[id];
                if (product) {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between bg-stone-100 p-2 rounded cursor-grab';
                    el.setAttribute('draggable', 'true');
                    el.dataset.id = product.id;
                    el.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="grip-vertical" class="w-5 h-5 text-stone-400 mr-2"></i>
                            <span>${product.name} (ID: ${product.id})</span>
                        </div>
                        <button class="remove-carousel-item-btn text-red-500 hover:text-red-700" data-id="${product.id}">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                        </button>
                    `;
                    carouselSelectedProducts.appendChild(el);
                }
            });
            lucide.createIcons();
        }

        const debouncedCarouselSearch = debounce(async (term) => {
            if (term.length < 2) {
                carouselSearchResults.classList.add('hidden');
                return;
            }
            try {
                const { products } = await api.get(`/api/products?search=${encodeURIComponent(term)}&limit=5`);
                carouselSearchResults.innerHTML = '';
                if (products.length > 0) {
                    products.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-stone-100 cursor-pointer';
                        item.textContent = `${p.name} (ID: ${p.id})`;
                        item.dataset.id = p.id;
                        item.addEventListener('click', () => {
                            if (carouselProductIds.length < 5 && !carouselProductIds.includes(p.id)) {
                                carouselProductIds.push(p.id);
                                carouselProductCache[p.id] = p;
                                renderSelectedCarouselProducts();
                            }
                            carouselProductSearch.value = '';
                            carouselSearchResults.classList.add('hidden');
                        });
                        carouselSearchResults.appendChild(item);
                    });
                    carouselSearchResults.classList.remove('hidden');
                } else {
                    carouselSearchResults.innerHTML = '<div class="p-2 text-stone-500">No results found.</div>';
                    carouselSearchResults.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Carousel search error:', error);
            }
        }, 300);

        carouselProductSearch.addEventListener('input', () => {
            debouncedCarouselSearch(carouselProductSearch.value);
        });

        // Drag and Drop for Carousel
        let draggedCarouselItem = null;
        carouselSelectedProducts.addEventListener('dragstart', e => {
            draggedCarouselItem = e.target.closest('[draggable="true"]');
            if (draggedCarouselItem) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedCarouselItem.dataset.id);
                setTimeout(() => {
                    draggedCarouselItem.classList.add('dragging');
                }, 0);
            }
        });

        carouselSelectedProducts.addEventListener('dragend', () => {
            if (draggedCarouselItem) {
                draggedCarouselItem.classList.remove('dragging');
                draggedCarouselItem = null;
            }
        });

        carouselSelectedProducts.addEventListener('dragover', e => {
            e.preventDefault();
            const target = e.target.closest('[draggable="true"]');
            if (target && target !== draggedCarouselItem) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                carouselSelectedProducts.insertBefore(draggedCarouselItem, next ? target.nextSibling : target);
            }
        });

        carouselSelectedProducts.addEventListener('drop', () => {
            const newOrder = [...carouselSelectedProducts.querySelectorAll('[data-id]')].map(el => parseInt(el.dataset.id));
            carouselProductIds = newOrder;
        });

        carouselSelectedProducts.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-carousel-item-btn');
            if (removeBtn) {
                const idToRemove = parseInt(removeBtn.dataset.id);
                carouselProductIds = carouselProductIds.filter(id => id !== idToRemove);
                renderSelectedCarouselProducts();
            }
        });

        saveCarouselBtn.addEventListener('click', async () => {
            saveCarouselBtn.disabled = true;
            saveCarouselBtn.innerHTML = `<span class="spinner"></span> Saving...`;
            try {
                await api.put('/api/admin/config/carousel', { productIds: carouselProductIds });
                alert('Carousel configuration saved!');
            } catch (error) {
                console.error('Failed to save carousel config:', error);
                alert(`Error saving carousel: ${error.message}`);
            } finally {
                saveCarouselBtn.disabled = false;
                saveCarouselBtn.textContent = 'Save Carousel';
            }
        });

        // --- TOP PICKS MANAGEMENT ---
        let topPicksProductIds = [];
        let topPicksProductCache = {};

        async function loadTopPicksConfig() {
            try {
                topPicksProductIds = await api.get('/api/admin/config/top-picks');
                const productsToFetch = topPicksProductIds.filter(id => !topPicksProductCache[id]);
                if (productsToFetch.length > 0) {
                    for (const id of productsToFetch) {
                        topPicksProductCache[id] = await api.get(`/api/products/${id}`);
                    }
                }
                renderSelectedTopPicks();
            } catch (error) {
                console.error('Error loading Top Picks config:', error);
            }
        }

        function renderSelectedTopPicks() {
            topPicksSelectedProducts.innerHTML = '';
            if (topPicksProductIds.length === 0) {
                topPicksSelectedProducts.innerHTML = '<p class="text-stone-500">No products selected for Top Picks.</p>';
                return;
            }
            topPicksProductIds.forEach(id => {
                const product = topPicksProductCache[id];
                if (product) {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between bg-stone-100 p-2 rounded cursor-grab';
                    el.setAttribute('draggable', 'true');
                    el.dataset.id = product.id;
                    el.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="grip-vertical" class="w-5 h-5 text-stone-400 mr-2"></i>
                            <span>${product.name} (ID: ${product.id})</span>
                        </div>
                        <button class="remove-top-pick-item-btn text-red-500 hover:text-red-700" data-id="${product.id}">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                        </button>
                    `;
                    topPicksSelectedProducts.appendChild(el);
                }
            });
            lucide.createIcons();
        }

        const debouncedTopPicksSearch = debounce(async (term) => {
            if (term.length < 2) {
                topPicksSearchResults.classList.add('hidden');
                return;
            }
            try {
                const { products } = await api.get(`/api/products?search=${encodeURIComponent(term)}&limit=5`);
                topPicksSearchResults.innerHTML = '';
                if (products.length > 0) {
                    products.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-stone-100 cursor-pointer';
                        item.textContent = `${p.name} (ID: ${p.id})`;
                        item.dataset.id = p.id;
                        item.addEventListener('click', () => {
                            if (topPicksProductIds.length < 4 && !topPicksProductIds.includes(p.id)) {
                                topPicksProductIds.push(p.id);
                                topPicksProductCache[p.id] = p;
                                renderSelectedTopPicks();
                            }
                            topPicksSearch.value = '';
                            topPicksSearchResults.classList.add('hidden');
                        });
                        topPicksSearchResults.appendChild(item);
                    });
                    topPicksSearchResults.classList.remove('hidden');
                } else {
                    topPicksSearchResults.innerHTML = '<div class="p-2 text-stone-500">No results found.</div>';
                }
            } catch (error) {
                console.error('Top Picks search error:', error);
            }
        }, 300);

        topPicksSearch.addEventListener('input', () => debouncedTopPicksSearch(topPicksSearch.value));

        // Drag and Drop for Top Picks
        let draggedTopPickItem = null;
        topPicksSelectedProducts.addEventListener('dragstart', e => {
            draggedTopPickItem = e.target.closest('[draggable="true"]');
            if (draggedTopPickItem) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedTopPickItem.dataset.id);
                setTimeout(() => draggedTopPickItem.classList.add('dragging'), 0);
            }
        });

        topPicksSelectedProducts.addEventListener('dragend', () => {
            if (draggedTopPickItem) {
                draggedTopPickItem.classList.remove('dragging');
                draggedTopPickItem = null;
            }
        });

        topPicksSelectedProducts.addEventListener('dragover', e => {
            e.preventDefault();
            const target = e.target.closest('[draggable="true"]');
            if (target && target !== draggedTopPickItem) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                topPicksSelectedProducts.insertBefore(draggedTopPickItem, next ? target.nextSibling : target);
            }
        });

        topPicksSelectedProducts.addEventListener('drop', () => {
            topPicksProductIds = [...topPicksSelectedProducts.querySelectorAll('[data-id]')].map(el => parseInt(el.dataset.id));
        });

        topPicksSelectedProducts.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-top-pick-item-btn');
            if (removeBtn) {
                const idToRemove = parseInt(removeBtn.dataset.id);
                topPicksProductIds = topPicksProductIds.filter(id => id !== idToRemove);
                renderSelectedTopPicks();
            }
        });

        saveTopPicksBtn.addEventListener('click', async () => {
            saveTopPicksBtn.disabled = true;
            saveTopPicksBtn.innerHTML = `<span class="spinner"></span> Saving...`;
            try {
                await api.put('/api/admin/config/top-picks', { productIds: topPicksProductIds });
                alert('Top Picks configuration saved!');
            } catch (error) {
                console.error('Failed to save Top Picks config:', error);
                alert(`Error saving Top Picks: ${error.message}`);
            } finally {
                saveTopPicksBtn.disabled = false;
                saveTopPicksBtn.textContent = 'Save Top Picks';
            }
        });

        function initializeDashboard() {
            lucide.createIcons();
            loadDashboardStats();
            loadOrders(currentOrderPage, orderSearchQuery);
            loadProductsAdmin(currentPage, searchQuery);
            loadCarouselConfig();
            loadTopPicksConfig();
        }

        // --- MODAL & FORM LOGIC ---
        function openModal(mode = 'add', product = null) {
            currentEditingProduct = product;
            productForm.reset();
            formStatus.textContent = '';
            formSubmitBtn.disabled = false;
            formSubmitBtn.innerHTML = 'Save Product';
            uploadedImageUrls = [];
            imagePreviews.innerHTML = '';

            if (mode === 'edit' && product) {
                modalTitle.textContent = 'Edit Product';
                document.getElementById('product-db-id').value = product.id;
                document.getElementById('product-legacyId').value = product.id;
                document.getElementById('product-legacyId').readOnly = true;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-originalPrice').value = product.originalPrice || '';
                document.getElementById('product-category').value = (product.category || []).join(', ');
                document.getElementById('product-sellerTag').value = product.sellerTag || '';
                document.getElementById('product-deliveryDate').value = product.deliveryDate || '';
                
                uploadedImageUrls = [...(product.images || [])];
                renderImagePreviews();

            } else {
                modalTitle.textContent = 'Add New Product';
                document.getElementById('product-legacyId').readOnly = false;
            }

            productModal.classList.remove('hidden');
            productModal.classList.add('flex');
            setTimeout(() => {
                productModalContent.classList.add('scale-100', 'opacity-100');
                productModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            productModalContent.classList.remove('scale-100', 'opacity-100');
            productModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                productModal.classList.add('hidden');
                productModal.classList.remove('flex');
            }, 300);
        }

        addProductBtn.addEventListener('click', () => openModal('add'));
        modalCloseBtn.addEventListener('click', closeModal);
        modalCancelBtn.addEventListener('click', closeModal);
        productModal.addEventListener('click', (e) => {
            if (e.target === productModal) closeModal();
        });

        productForm.addEventListener('submit', async (e) => {
            if (activeUploads > 0) {
                e.preventDefault();
                return;
            }
            e.preventDefault();
            formSubmitBtn.disabled = true;
            formSubmitBtn.innerHTML = `<span class="spinner"></span> Saving...`;
            formStatus.textContent = '';

            const isEditMode = !!currentEditingProduct;
            const productId = isEditMode ? currentEditingProduct.id : null;

            const productData = {
                legacyId: parseInt(document.getElementById('product-legacyId').value),
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                originalPrice: parseFloat(document.getElementById('product-originalPrice').value) || null,
                category: document.getElementById('product-category').value.split(',').map(c => c.trim()).filter(Boolean),
                sellerTag: document.getElementById('product-sellerTag').value || null,
                deliveryDate: document.getElementById('product-deliveryDate').value || null,
                images: uploadedImageUrls
            };

            try {
                if (isEditMode) {
                    await api.put(`/api/products/${productId}`, productData);
                    formStatus.textContent = 'Product updated successfully!';
                } else {
                    await api.post('/api/products', productData);
                    formStatus.textContent = 'Product added successfully!';
                }
                formStatus.className = 'text-sm font-medium mr-auto text-green-600';
                await loadProductsAdmin();
                setTimeout(closeModal, 1500);

            } catch (error) {
                console.error('Form submission error:', error);
                formStatus.textContent = `Error: ${error.message}`;
                formStatus.className = 'text-sm font-medium mr-auto text-red-600';
                formSubmitBtn.disabled = false;
                formSubmitBtn.innerHTML = 'Save Product';
            }
        });

        // --- TABLE ACTIONS (EDIT/DELETE) ---
        productsTableBody.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (editBtn) {
                const productId = parseInt(editBtn.dataset.id);
                const product = allProducts.find(p => p.id === productId);
                if (product) openModal('edit', product);
            }

            if (deleteBtn) {
                const productId = parseInt(deleteBtn.dataset.id);
                if (confirm(`Are you sure you want to delete product ID ${productId}? This cannot be undone.`)) {
                    try {
                        await api.delete(`/api/products/${productId}`);
                        alert('Product deleted successfully.');
                        loadProductsAdmin();
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert(`Failed to delete product: ${error.message}`);
                    }
                }
            }
        });

        // --- IMAGE UPLOAD LOGIC ---
        imageDropzone.addEventListener('click', () => imageUploadInput.click());
        imageDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageDropzone.classList.add('dragover');
        });
        imageDropzone.addEventListener('dragleave', () => imageDropzone.classList.remove('dragover'));
        imageDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            imageDropzone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFiles(files);
            }
        });
        imageUploadInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length) {
                handleFiles(files);
            }
        });

        async function handleFiles(files) {
            activeUploads += files.length;
            updateSubmitButton();

            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    activeUploads--;
                    continue;
                }

                const tempId = `temp-${Date.now()}-${Math.random()}`;
                addPreview(file, tempId);

                try {
                    const result = await api.upload(file);
                    const uploadedUrl = result.url;

                    // Update the preview with the real URL and add to our list
                    const tempPreview = document.getElementById(tempId);
                    if (tempPreview) {
                        tempPreview.dataset.url = uploadedUrl;
                        uploadedImageUrls.push(uploadedUrl);
                        tempPreview.querySelector('.spinner-container').remove();
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                    const tempPreview = document.getElementById(tempId);
                    if (tempPreview) {
                        tempPreview.querySelector('.spinner-container').innerHTML = `<i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>`;
                        lucide.createIcons();
                    }
                } finally {
                    activeUploads--;
                    updateSubmitButton();
                }
            }
        }

        function addPreview(file, tempId) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewContainer = document.createElement('div');
                previewContainer.id = tempId;
                previewContainer.className = 'thumbnail-container';
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-24 object-cover rounded-md border">
                    <div class="spinner-container absolute inset-0 flex items-center justify-center bg-white/70">
                        <div class="spinner"></div>
                    </div>
                    <div class="thumbnail-remove-btn">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </div>
                `;
                imagePreviews.appendChild(previewContainer);
                lucide.createIcons();
            };
            reader.readAsDataURL(file);
        }

        function renderImagePreviews() {
            imagePreviews.innerHTML = uploadedImageUrls.map(url => `
                <div class="thumbnail-container" data-url="${url}">
                    <img src="${url}" class="w-full h-24 object-cover rounded-md border">
                    <div class="thumbnail-remove-btn">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        imagePreviews.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.thumbnail-remove-btn');
            if (removeBtn) {
                const container = removeBtn.closest('.thumbnail-container');
                const urlToRemove = container.dataset.url;
                uploadedImageUrls = uploadedImageUrls.filter(url => url !== urlToRemove);
                container.remove();
            }
        });

        function updateSubmitButton() {
            formSubmitBtn.disabled = activeUploads > 0;
            if (activeUploads > 0) {
                formSubmitBtn.textContent = `Uploading ${activeUploads} image${activeUploads > 1 ? 's' : ''}...`;
            } else {
                formSubmitBtn.textContent = 'Save Product';
            }
        }

        // --- INITIALIZATION ---
        checkAuth();

    </script>
</body>
</html>