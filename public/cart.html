<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart - Brundavanam Goshala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.0/lottie.min.js"></script>
    <style> 
        body { font-family: 'Poppins', sans-serif; } 
        /* Cart count animation */
        .cart-count-animate { animation: jiggle 0.4s ease-in-out; }
        @keyframes jiggle {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        .nav-link-glow {
            transition: text-shadow 0.3s ease;
        }
        .nav-link-glow:hover {
            text-shadow: 0 0 8px rgba(22, 101, 52, 0.7);
        }
        /* Header shrink styles */
        .header-scrolled #header-container {
            height: 3rem; /* h-12 */
        }
        .header-scrolled #logo-link {
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem;
        }

        /* Spinner animation */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.75s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom Logo Loader */
        .loader-logo {
            animation: blink 1.5s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }
    </style>
</head>
<body class="bg-stone-100">

    <!-- Page Loader -->
    <div id="page-loader" class="fixed inset-0 z-[9999] flex items-center justify-center bg-white transition-opacity duration-300 ease-in-out">
        <!-- Replace with the direct URL to your logo image (e.g., assets/logo.png) -->
        <img src="/logo.png" alt="Brundavanam Goshala Logo" class="loader-logo w-24 h-24">
    </div>

    <!-- Search Overlay -->
    <div id="search-overlay" class="fixed inset-0 z-[1001] bg-black/70 backdrop-blur-sm hidden items-start justify-center p-4 pt-24 md:pt-32 transition-opacity duration-300">
        <div class="w-full max-w-xl transform -translate-y-full transition-transform duration-300" id="search-overlay-content">
            <div class="relative">
                <input type="text" id="overlay-search-input" placeholder="Search for products..." class="w-full p-4 pr-12 text-lg text-stone-800 bg-white/90 border-2 border-white rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" autocomplete="off">
                <i data-lucide="search" class="absolute top-1/2 right-4 -translate-y-1/2 w-6 h-6 text-stone-500"></i>
            </div>
            <!-- Suggestions for overlay search -->
            <div id="overlay-search-suggestions" class="w-full bg-white border border-stone-200 rounded-lg shadow-lg z-20 hidden mt-2 overflow-hidden max-h-80 overflow-y-auto">
                <!-- Suggestions will be injected here -->
            </div>
        </div>
        <button id="overlay-close-button" class="absolute top-6 right-6 text-white/70 hover:text-white">
            <i data-lucide="x" class="w-10 h-10"></i>
        </button>
    </div>

    <!-- Header -->
    <header id="main-header" class="app-bar sticky top-0 left-0 w-full transition-all duration-300 z-[100]" style="background: rgba(200, 200, 200, 0.25); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: 16px; border: 1px solid rgba(200, 200, 200, 0.3); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);">
        <div id="header-container" class="h-12 md:h-16 px-4 md:px-8 flex items-center justify-between transition-all duration-300 container mx-auto">
            <!-- Logo -->
            <a id="logo-link" href="index.html" class="text-lg sm:text-xl font-bold text-green-900 hover:text-green-700 mr-6 transition-all duration-300">Brundavanam Goshala</a>

            <!-- Nav Links (Desktop) -->
            <nav class="hidden md:flex items-center gap-6 text-stone-800 font-medium">
                <a href="index.html" class="nav-link-glow">Home</a>
                <a href="about.html" class="nav-link-glow">About Us</a>
                <a href="index.html" class="nav-link-glow">Shop</a>
                <a href="contact.html" class="nav-link-glow">Contact</a>
            </nav>

            <!-- Actions -->
            <div class="flex items-center gap-2 md:gap-4">
                <button id="header-search-button" class="hidden md:block p-2 rounded-full bg-white/20 backdrop-blur-sm text-stone-700 hover:bg-white/40">
                    <i data-lucide="search" class="w-5 h-5"></i>
                </button>
                <a href="my-orders.html" class="hidden md:block p-2 rounded-full bg-white/20 backdrop-blur-sm text-stone-700 hover:bg-white/40" title="My Account">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </a>
                <a href="cart.html" class="relative p-2 rounded-full bg-white/20 backdrop-blur-sm text-green-800 hover:bg-white/40">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-amber-600 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span>
                </a>
                <button id="mobile-menu-button" class="md:hidden p-2 rounded-full bg-white/20 backdrop-blur-sm text-stone-700 hover:bg-white/40">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white/80 backdrop-blur-sm border rounded-2xl mt-2 p-4 pt-10 space-y-2 shadow-xl relative">
            <button id="mobile-menu-close-btn" class="absolute top-2 right-2 p-1 text-stone-500 hover:text-stone-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <a href="index.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Home</a>
            <a href="about.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">About Us</a>
            <a href="index.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Shop</a>
            <a href="contact.html" class="block text-gray-700 hover:bg-stone-100 p-2 rounded">Contact</a>
            <button id="mobile-header-search-button" class="w-full flex items-center justify-center gap-2 text-stone-700 bg-stone-200/70 hover:bg-stone-300/70 p-2 rounded-lg font-medium">
                <i data-lucide="search" class="w-4 h-4"></i> Search
            </button>
            <a href="my-orders.html" class="w-full flex items-center justify-center gap-2 text-stone-700 bg-stone-200/70 hover:bg-stone-300/70 p-2 rounded-lg font-medium">
                <i data-lucide="user" class="w-4 h-4"></i> My Account
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 pt-28 md:pt-32" style="padding-top: 90px;">
        <div class="flex justify-between items-baseline mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-stone-800">Your Shopping Cart</h1>
            <button id="clear-cart-btn" class="text-sm text-red-600 hover:underline font-medium hidden">Clear Cart</button>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Cart Items -->
            <div id="cart-items-container" class="flex-grow space-y-4">
                <!-- Cart items will be dynamically inserted here -->
            </div>

            <!-- Order Summary -->
            <div id="order-summary-container" class="lg:w-1/3 lg:flex-shrink-0">
                <div class="bg-white p-6 rounded-lg shadow-md sticky top-28">
                    <h2 class="text-xl font-bold text-stone-800 mb-4 border-b pb-4">Order Summary</h2>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-stone-600">
                            <span>Subtotal</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                         <div class="flex justify-between text-stone-600">
                            <span>Delivery Fee</span>
                            <span class="font-medium text-green-600">FREE</span>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex justify-between font-bold text-lg text-stone-800">
                            <span>Total Amount</span>
                            <span id="total">₹0.00</span>
                        </div>
                    </div>
                    <button id="checkout-btn" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-lg disabled:bg-stone-400">
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </div>

        <!-- Recommended Products Section -->
        <div id="recommended-section" class="mt-16 hidden pb-16 md:pb-0">
            <h2 class="text-2xl font-bold text-stone-800 mb-6">You Might Also Like</h2>
            <div id="recommended-products-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- Recommended products will be injected here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Bottom Navigation Bar (Mobile Only) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.1)] z-[101]">
        <div class="flex justify-around h-16">
            <a href="index.html" class="flex flex-col items-center justify-center text-stone-600 hover:text-green-700 w-full">
                <i data-lucide="home" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Home</span>
            </a>
            <button id="mobile-bottom-search" class="flex flex-col items-center justify-center text-stone-600 hover:text-green-700 w-full">
                <i data-lucide="search" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Search</span>
            </button>
            <a href="cart.html" class="relative flex flex-col items-center justify-center text-green-700 font-semibold w-full">
                <i data-lucide="shopping-cart" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Cart</span>
            </a>
            <a href="my-orders.html" class="flex flex-col items-center justify-center text-stone-600 hover:text-green-700 w-full">
                <i data-lucide="user" class="w-6 h-6 mb-1"></i>
                <span class="text-xs">Account</span>
            </a>
        </div>
    </nav>
    <footer class="bg-stone-800 text-white mt-12 pb-16 md:pb-0">
        <div class="container mx-auto px-8 py-12 text-center">
             <p class="font-bold text-2xl mb-2">Brundavanam Goshala</p>
             <p class="text-stone-400 max-w-xl mx-auto mb-6">Promoting wellness and sustainability through sacred cow products, while supporting the care and protection of our beloved Gomata.</p>
             <div class="flex justify-center space-x-6">
                 <a href="about.html" class="text-stone-300 hover:text-white">About Us</a>
                 <a href="contact.html" class="text-stone-300 hover:text-white">Contact & Support</a>
                 <a href="#" class="text-stone-300 hover:text-white">Terms of Service</a>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button id="back-to-top-btn" title="Go to top" class="fixed bottom-20 right-5 z-50 p-3 rounded-full bg-green-600 text-white shadow-lg hover:bg-green-700 transition-all duration-300 opacity-0 translate-y-4 pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
    </button>

    <script type="module">
        import { loadProducts } from '/js/data.js';
        import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.esm.js';

        // --- UTILITIES ---
        const debounce = (func, delay = 300) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        let fuse;
        let allProducts = [];

        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', async () => {
            // --- PAGE LOADER LOGIC ---
            const pageLoader = document.getElementById('page-loader');
            if (pageLoader) {
                pageLoader.classList.add('opacity-0');
                // After the transition, hide it so it doesn't block interactions
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 300); // Match duration-300
            }

            // --- HEADER SCROLL EFFECT (NEW) ---
            const mainHeader = document.getElementById('main-header');
            if (mainHeader) {
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 50) {
                        mainHeader.classList.add('header-scrolled');
                    } else {
                        mainHeader.classList.remove('header-scrolled');
                    }
                });
            }
            
            const cartItemsContainer = document.getElementById('cart-items-container');
            const orderSummaryContainer = document.getElementById('order-summary-container');
            const cartCountElement = document.getElementById('cart-count');
            let products = []; // This will hold the cart state

            try {
                products = await loadProducts(false); // Fetch all products for cart logic
            } catch (error) {
                console.error("Failed to load products:", error);
            }

            // Initialize fuzzy search after products are loaded
            allProducts = await loadProducts(false);
            const options = {
                includeScore: true,
                minMatchCharLength: 2,
                threshold: 0.4,
                keys: [
                    { name: 'name', weight: 0.7 }, { name: 'description', weight: 0.3 }, { name: 'category', weight: 0.5 }
                ]
            };
            fuse = new Fuse(allProducts, options);

            function updateCartCount(newCount) {
                const currentCount = parseInt(cartCountElement.textContent);
                if (newCount !== currentCount) {
                    cartCountElement.textContent = newCount;
                    cartCountElement.classList.add('cart-count-animate');
                    cartCountElement.addEventListener('animationend', () => {
                        cartCountElement.classList.remove('cart-count-animate');
                    }, { once: true });
                }
            }

            function saveProductsToStorage() {
                // Only save the cart state (id, inCart, quantity) to avoid overwriting product details
                const cartState = products
                    .filter(p => p.inCart)
                    .map(({id, inCart, quantity}) => ({id, inCart, quantity}));
                localStorage.setItem('goshalaProducts', JSON.stringify(cartState));
            }

            function renderCart() {
                const cartItems = products.filter(p => p.inCart);
                updateCartCount(cartItems.length);
                const clearCartBtn = document.getElementById('clear-cart-btn');
                const checkoutBtn = document.getElementById('checkout-btn');
                cartItemsContainer.innerHTML = ''; 

                if (cartItems.length === 0) {
                    if (clearCartBtn) clearCartBtn.classList.add('hidden');
                    // Updated empty cart view with Lottie animation
                    cartItemsContainer.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-md text-center lg:col-span-3 flex flex-col items-center">
                            <div id="empty-cart-animation" class="w-64 h-64" role="img" aria-label="Animation of an empty box."></div>
                            <h2 class="text-2xl font-semibold text-stone-700 mb-2">Your cart is empty!</h2>
                            <p class="text-stone-500 mb-6">Looks like you haven't added anything to your cart yet.</p>
                            <a href="index.html" class="inline-block bg-amber-600 hover:bg-amber-700 text-stone-900 font-bold py-3 px-8 rounded-lg">Browse Products</a>
                        </div>`;
                    orderSummaryContainer.style.display = 'none';
                    if (checkoutBtn) checkoutBtn.disabled = true;                    
                    
                    // Initialize Lottie animation
                    lottie.loadAnimation({
                        container: document.getElementById('empty-cart-animation'),
                        renderer: 'svg', loop: true, autoplay: true, path: '/assets/Empty box.json'
                    });
                    return;
                }

                orderSummaryContainer.style.display = 'block';
                if (checkoutBtn) checkoutBtn.disabled = false;
                let subtotal = 0;
                
                if (clearCartBtn) clearCartBtn.classList.remove('hidden');
                cartItems.forEach(item => {
                    subtotal += item.price * item.quantity;
                    const itemElement = document.createElement('div');
                    itemElement.className = "bg-white p-4 rounded-lg shadow-md flex gap-4";
                    itemElement.innerHTML = `
                        <div class="flex-shrink-0">
                            <img src="${(item.images && item.images.length > 0) ? item.images[0] : 'https://placehold.co/100x100/CCCCCC/FFFFFF?text=No+Image'}" alt="${item.name}" class="w-20 h-20 md:w-24 md:h-24 object-cover rounded-md">
                        </div>
                        <div class="flex-grow flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <div class="flex-grow">
                                <h3 class="font-semibold text-stone-800">${item.name}</h3>
                                <p class="text-sm text-stone-500 mt-1">Price: ₹${item.price}</p>
                            </div>
                            <div class="flex flex-col items-start sm:items-end gap-2">
                                <div class="flex items-center border border-stone-300 rounded-md">
                                    <button class="quantity-change px-3 py-1 text-lg font-bold text-stone-600 hover:bg-stone-100 rounded-l-md" data-id="${item.id}" data-change="-1">-</button>
                                    <input type="text" value="${item.quantity}" class="w-10 text-center border-none text-base focus:ring-0" readonly>
                                    <button class="quantity-change px-3 py-1 text-lg font-bold text-stone-600 hover:bg-stone-100 rounded-r-md" data-id="${item.id}" data-change="1">+</button>
                                </div>
                                <p class="font-bold text-lg text-stone-800">₹${(item.price * item.quantity).toFixed(2)}</p>
                                <button class="remove-item-btn text-red-500 hover:text-red-700 text-xs font-medium" data-id="${item.id}">Remove</button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });

                document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
                document.getElementById('total').textContent = `₹${subtotal.toFixed(2)}`;
            }
            
            function renderRecommendedProducts() {
                const recommendedGrid = document.getElementById('recommended-products-grid');
                const recommendedSection = document.getElementById('recommended-section');
                if (!recommendedGrid || !recommendedSection) return;

                const cartItemIds = new Set(products.filter(p => p.inCart).map(p => p.id));
                if (cartItemIds.size === 0) {
                    recommendedSection.classList.add('hidden');
                    return;
                }

                const cartCategories = new Set(products.filter(p => p.inCart && p.category).flatMap(p => p.category));

                let recommended = products.filter(p => 
                    !cartItemIds.has(p.id) && 
                    p.category && 
                    p.category.some(cat => cartCategories.has(cat))
                );

                // Shuffle and take the top 4
                const finalRecommended = recommended.sort(() => 0.5 - Math.random()).slice(0, 4);

                if (finalRecommended.length > 0) {
                    recommendedGrid.innerHTML = finalRecommended.map(product => {
                        const imageUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/400x300/CCCCCC/FFFFFF?text=No+Image';
                        return `
                            <a href="product-detail.html?id=${product.id}" class="block bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 group">
                                <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                                <div class="p-4">
                                    <h3 class="font-medium text-sm text-stone-800 leading-tight mb-2 group-hover:text-green-700 transition-colors">${product.name}</h3>
                                    <p class="text-xl font-bold text-stone-800">₹${product.price}</p>
                                </div>
                            </a>
                        `;
                    }).join('');
                    recommendedSection.classList.remove('hidden');
                }
            }

            // Event Delegation for cart item actions
            cartItemsContainer.addEventListener('click', (event) => {
                const quantityButton = event.target.closest('.quantity-change');
                const removeButton = event.target.closest('.remove-item-btn');

                if (quantityButton) {
                    const productId = parseInt(quantityButton.dataset.id);
                    const change = parseInt(quantityButton.dataset.change);
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        product.quantity += change;
                        if (product.quantity <= 0) {
                            product.inCart = false;
                            product.quantity = 0;
                        }
                        saveProductsToStorage();
                        renderCart();
                    }
                } else if (removeButton) {
                    const productId = parseInt(removeButton.dataset.id);
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        product.inCart = false;
                        product.quantity = 0;
                        saveProductsToStorage();
                        renderCart();
                    }
                }
            });

            // Clear cart button functionality
            const clearCartBtn = document.getElementById('clear-cart-btn');
            if (clearCartBtn) {
                clearCartBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear your entire cart?')) {
                        products.forEach(p => {
                            p.inCart = false;
                            p.quantity = 0;
                        });
                        saveProductsToStorage();
                        renderCart();
                        renderRecommendedProducts();
                    }
                });
            }

            // Checkout button functionality
            const checkoutBtn = document.getElementById('checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', () => {
                    const cartItems = products.filter(p => p.inCart);
                    if (cartItems.length > 0) {
                        window.location.href = 'checkout.html';
                    }
                });
            }

            renderCart();
            renderRecommendedProducts();

            // Listen for storage changes to sync cart across tabs
            window.addEventListener('storage', (event) => {
                if (event.key === 'goshalaProducts') {
                    // Data has changed in another tab, reload and re-render
                    loadProducts().then(newProducts => {
                        products = newProducts;
                        renderCart();
                        renderRecommendedProducts();
                    });
                }
            });

            // Mobile Menu Toggle & Active Link
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                const closeBtn = document.getElementById('mobile-menu-close-btn');
                
                const toggleMenu = (show) => mobileMenu.classList.toggle('hidden', !show);

                mobileMenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMenu(true);
                });
                if(closeBtn) closeBtn.addEventListener('click', () => toggleMenu(false));

                document.addEventListener('click', (e) => {
                    if (!mobileMenu.classList.contains('hidden') && !mobileMenu.contains(e.target) && e.target !== mobileMenuButton) {
                        toggleMenu(false);
                    }
                });
            }

            // --- SEARCH OVERLAY LOGIC ---
            const headerSearchButton = document.getElementById('header-search-button');
            const mobileHeaderSearchButton = document.getElementById('mobile-header-search-button');
            const searchOverlay = document.getElementById('search-overlay');
            const searchOverlayContent = document.getElementById('search-overlay-content');
            const overlaySearchInput = document.getElementById('overlay-search-input');
            const overlayCloseButton = document.getElementById('overlay-close-button');

            function openSearch() {
                searchOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    searchOverlay.classList.add('opacity-100');
                    searchOverlayContent.classList.remove('-translate-y-full');
                    overlaySearchInput.focus();
                }, 10);
            }

            function closeSearch() {
                searchOverlay.classList.remove('opacity-100');
                searchOverlayContent.classList.add('-translate-y-full');
                setTimeout(() => {
                    searchOverlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }, 300);
            }

            function performSearch() {
                const query = overlaySearchInput.value.trim();
                if (query) {
                    window.location.href = `index.html?q=${encodeURIComponent(query)}#shop-search`;
                }
            }

            function renderOverlaySuggestions(results) {
                const container = document.getElementById('overlay-search-suggestions');
                if (!container) return;

                if (results.length > 0) {
                    container.innerHTML = results.map(result => {
                        const product = result.item;
                        const imageUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/100x100';
                        return `
                            <a href="product-detail.html?id=${product.id}" class="flex items-center p-3 hover:bg-stone-100 transition-colors border-t border-stone-100 first:border-t-0">
                                <img src="${imageUrl}" alt="${product.name}" class="w-12 h-12 object-cover rounded-md mr-4">
                                <div><p class="font-medium text-stone-800 text-sm">${product.name}</p><p class="text-sm font-bold text-stone-700">₹${product.price}</p></div>
                            </a>`;
                    }).join('');
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }

            headerSearchButton.addEventListener('click', openSearch);
            mobileHeaderSearchButton.addEventListener('click', openSearch);

            // Search button in bottom nav
            const mobileBottomSearch = document.getElementById('mobile-bottom-search');
            if (mobileBottomSearch) mobileBottomSearch.addEventListener('click', openSearch);
            
            overlayCloseButton.addEventListener('click', closeSearch);
            searchOverlay.addEventListener('click', (e) => { if (e.target === searchOverlay) closeSearch(); });

            // Back to Top Button
            const backToTopBtn = document.getElementById('back-to-top-btn');
            if (backToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 400) backToTopBtn.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
                    else backToTopBtn.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
                });
                backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            }

            overlaySearchInput.addEventListener('input', debounce(() => {
                const query = overlaySearchInput.value.trim();
                if (query.length > 1) {
                    const results = fuse.search(query).slice(0, 5);
                    renderOverlaySuggestions(results);
                } else {
                    document.getElementById('overlay-search-suggestions').classList.add('hidden');
                }
            }, 300));
            overlaySearchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { performSearch(); document.getElementById('overlay-search-suggestions').classList.add('hidden'); } });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !searchOverlay.classList.contains('hidden')) closeSearch(); });
        });

        // Handle back/forward navigation from bfcache
        window.addEventListener('pageshow', function(event) {
            // When a page is restored from bfcache, the loader might be visible.
            // We just need to hide it, not reload the whole page.
            const pageLoader = document.getElementById('page-loader');
            if (event.persisted) {
                if (pageLoader && pageLoader.style.display !== 'none') {
                    pageLoader.classList.add('opacity-0');
                    setTimeout(() => pageLoader.style.display = 'none', 50); // Hide it quickly
                }
            }
        });
    </script>

</body>
</html>